<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The BigQuery ML Predictor Lab: A Visual Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 40vh;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        .gradient-text {
            background: linear-gradient(to right, #76D7C4, #A3E4D7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .flow-arrow {
            font-size: 2rem;
            color: #48C9B0;
        }
        .flow-node {
            border: 2px solid #48C9B0;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="container mx-auto p-4 md:p-8">

        <header class="text-center my-12">
            <h1 class="text-4xl md:text-6xl font-black tracking-tight leading-tight">
                The BQML Predictor Lab
            </h1>
            <p class="mt-4 text-xl md:text-2xl font-light gradient-text">A Visual Guide to Training a "Big Tipper" Classifier</p>
        </header>

        <main>
            <section id="mission" class="my-16 text-center">
                <h2 class="text-3xl font-bold mb-4">The Mission: Predict High-Value Tips</h2>
                <p class="max-w-3xl mx-auto text-lg text-gray-400 mb-8">As a data scientist at a ride-hailing company, your goal is to build a model that predicts which taxi rides will result in a "big tip" (‚â•20% of the fare). This infographic breaks down the entire process, from data to deployment-ready artifact.</p>
                <div class="bg-gray-800 rounded-lg shadow-2xl p-8 inline-block">
                    <p class="text-2xl font-semibold text-gray-400">Total Training Records Analyzed</p>
                    <p class="text-7xl font-black gradient-text">118,185</p>
                </div>
            </section>

            <section id="blueprint" class="my-20">
                <h2 class="text-3xl font-bold text-center mb-12">The Blueprint: End-to-End ML Workflow</h2>
                <div class="flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4 text-center">
                    <div class="flow-node bg-gray-800 p-4 rounded-lg shadow-lg">
                        <span class="text-4xl">üìä</span>
                        <p class="font-bold mt-2">Training Data</p>
                        <p class="text-sm text-gray-400">`taxi_ml.training`</p>
                    </div>
                    <div class="flow-arrow font-mono transform md:rotate-0 rotate-90">&rarr;</div>
                    <div class="flow-node bg-gray-800 p-4 rounded-lg shadow-lg">
                        <span class="text-4xl">ü§ñ</span>
                        <p class="font-bold mt-2">BQML Training</p>
                        <p class="text-sm text-gray-400">`CREATE MODEL`</p>
                    </div>
                    <div class="flow-arrow font-mono transform md:rotate-0 rotate-90">&rarr;</div>
                    <div class="flow-node bg-gray-800 p-4 rounded-lg shadow-lg">
                        <span class="text-4xl">üìà</span>
                        <p class="font-bold mt-2">Model Evaluation</p>
                        <p class="text-sm text-gray-400">`ML.EVALUATE`</p>
                    </div>
                     <div class="flow-arrow font-mono transform md:rotate-0 rotate-90">&rarr;</div>
                    <div class="flow-node bg-gray-800 p-4 rounded-lg shadow-lg">
                        <span class="text-4xl">üì§</span>
                        <p class="font-bold mt-2">Export Artifact</p>
                        <p class="text-sm text-gray-400">`EXPORT MODEL`</p>
                    </div>
                </div>
            </section>

            <section id="evaluation" class="my-20">
                <h2 class="text-3xl font-bold text-center mb-12">The Verdict: Evaluating Initial Performance</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <h3 class="text-xl font-bold mb-4">Tackling Class Imbalance</h3>
                        <p class="text-gray-400 mb-4">"Big tipper" rides are rare. The `auto_class_weights=TRUE` option is crucial because it forces the model to pay more attention to this minority class, preventing it from simply guessing "no big tip" every time.</p>
                        <div class="chart-container h-64 max-h-[30vh]">
                            <canvas id="imbalanceChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <h3 class="text-xl font-bold mb-4">Default Threshold (0.5) Metrics</h3>
                        <p class="text-gray-400 mb-4">These initial metrics for the "big tipper" class (1) show the model's baseline performance. Note the trade-off already appearing between precision and recall.</p>
                         <div class="chart-container h-64 max-h-[30vh]">
                            <canvas id="metricsChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <section id="tradeoff" class="my-20">
                <h2 class="text-3xl font-bold text-center mb-4">The Core Decision: The Precision-Recall Trade-Off</h2>
                <p class="max-w-4xl mx-auto text-lg text-gray-400 text-center mb-8">The default 0.5 probability threshold is rarely optimal. By analyzing the ROC curve data, we can choose a threshold that aligns with our business goal. This chart shows how precision and recall change as we adjust the model's confidence threshold.</p>
                <div class="bg-gray-800 p-6 rounded-lg shadow-xl">
                    <div class="chart-container h-96 max-h-[50vh]">
                        <canvas id="tradeoffChart"></canvas>
                    </div>
                </div>
            </section>
            
            <section id="handoff" class="my-20">
                <h2 class="text-3xl font-bold text-center mb-12">The Hand-Off: Exporting for Deployment</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <h3 class="text-xl font-bold mb-4">From BigQuery to Cloud Storage</h3>
                        <p class="text-gray-400 mb-4">The `EXPORT MODEL` command packages our trained BQML model into a standard TensorFlow SavedModel format. This artifact is then stored in a Google Cloud Storage bucket, ready for the MLOps team to use in a real-time prediction service.</p>
                        <div class="flex items-center justify-around text-center p-4">
                            <div>
                                <span class="text-6xl">ü§ñ</span>
                                <p class="font-bold mt-2">BigQuery ML Model</p>
                            </div>
                            <div class="flow-arrow font-mono">&rarr;</div>
                            <div>
                                <span class="text-6xl">üì¶</span>
                                <p class="font-bold mt-2">GCS Bucket</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <h3 class="text-xl font-bold mb-4">Anatomy of a SavedModel</h3>
                        <p class="text-gray-400 mb-4">The exported folder contains everything needed for serving, including the model graph and its learned weights (variables).</p>
                        <ul class="space-y-2 font-mono text-sm">
                            <li class="bg-gray-700 p-2 rounded"><span>üìÅ</span> /big_tipper/saved_model/</li>
                            <li class="bg-gray-900 p-2 rounded ml-4"><span>üìÑ</span> saved_model.pb</li>
                            <li class="bg-gray-900 p-2 rounded ml-4"><span>üìÅ</span> /variables/</li>
                            <li class="bg-gray-700 p-2 rounded ml-8"><span>üíæ</span> variables.data-00000-of-00001</li>
                            <li class="bg-gray-700 p-2 rounded ml-8"><span>üìÑ</span> variables.index</li>
                        </ul>
                    </div>
                </div>
            </section>

            <footer class="text-center my-16 border-t-2 border-gray-700 pt-8">
                <h2 class="text-2xl font-bold mb-4">Final Deliverables Checklist</h2>
                <ul class="inline-flex flex-col md:flex-row gap-4 md:gap-8 text-left">
                    <li class="text-lg"><span class="text-green-400">‚úÖ</span> Completed `.ipynb` Notebook</li>
                    <li class="text-lg"><span class="text-green-400">‚úÖ</span> `roc_curve.json` Data File</li>
                    <li class="text-lg"><span class="text-green-400">‚úÖ</span> Threshold Rationale Paragraph</li>
                </ul>
            </footer>
        </div>
    </main>

    <script>
        const brilliantBlues = {
            yellow: '#F9F871',
            lightTeal: '#A3E4D7',
            mediumTeal: '#76D7C4',
            darkTeal: '#48C9B0',
            veryDarkTeal: '#1ABC9C',
            deepestGreenTeal: '#17A589',
            textColor: '#E5E7EB',
            gridColor: 'rgba(229, 231, 235, 0.2)'
        };

        const chartTooltipOptions = {
            plugins: {
                tooltip: {
                    callbacks: {
                        title: function(tooltipItems) {
                            const item = tooltipItems[0];
                            let label = item.chart.data.labels[item.dataIndex];
                            if (Array.isArray(label)) {
                              return label.join(' ');
                            } else {
                              return label;
                            }
                        }
                    }
                }
            }
        };

        function wrapLabel(str, maxWidth) {
            if (str.length <= maxWidth) {
                return str;
            }
            const words = str.split(' ');
            let lines = [];
            let currentLine = '';
            for (const word of words) {
                if ((currentLine + word).length > maxWidth) {
                    lines.push(currentLine.trim());
                    currentLine = '';
                }
                currentLine += word + ' ';
            }
            lines.push(currentLine.trim());
            return lines.filter(line => line.length > 0);
        }

        new Chart(document.getElementById('imbalanceChart'), {
            type: 'doughnut',
            data: {
                labels: ['Not a Big Tipper', 'Big Tipper'],
                datasets: [{
                    label: 'Class Distribution',
                    data: [98488, 19697],
                    backgroundColor: [brilliantBlues.darkTeal, brilliantBlues.yellow],
                    borderColor: '#1F2937',
                    borderWidth: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    ...chartTooltipOptions.plugins,
                    legend: {
                        position: 'bottom',
                        labels: { color: brilliantBlues.textColor }
                    }
                }
            }
        });

        new Chart(document.getElementById('metricsChart'), {
            type: 'bar',
            data: {
                labels: ['Precision', 'Recall', 'Accuracy'],
                datasets: [{
                    label: 'Big Tipper (Class 1) Metrics at Threshold 0.5',
                    data: [0.65, 0.58, 0.88],
                    backgroundColor: [brilliantBlues.mediumTeal, brilliantBlues.lightTeal, brilliantBlues.veryDarkTeal],
                    borderColor: brilliantBlues.darkTeal,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                ...chartTooltipOptions,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 1,
                        ticks: { color: brilliantBlues.textColor },
                        grid: { color: brilliantBlues.gridColor }
                    },
                    x: {
                        ticks: { color: brilliantBlues.textColor },
                        grid: { color: 'transparent' }
                    }
                },
                plugins: {
                     ...chartTooltipOptions.plugins,
                    legend: { display: false }
                }
            }
        });
        
        const thresholds = [0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9];
        const precisionData = [0.35, 0.45, 0.55, 0.60, 0.65, 0.75, 0.85, 0.92, 0.98];
        const recallData = [0.95, 0.90, 0.82, 0.73, 0.58, 0.45, 0.32, 0.21, 0.10];

        new Chart(document.getElementById('tradeoffChart'), {
            type: 'line',
            data: {
                labels: thresholds.map(t => t.toFixed(1)),
                datasets: [{
                    label: 'Precision',
                    data: precisionData,
                    borderColor: brilliantBlues.yellow,
                    backgroundColor: brilliantBlues.yellow + '33',
                    tension: 0.3,
                    fill: false,
                    yAxisID: 'y',
                }, {
                    label: 'Recall',
                    data: recallData,
                    borderColor: brilliantBlues.lightTeal,
                    backgroundColor: brilliantBlues.lightTeal + '33',
                    tension: 0.3,
                    fill: false,
                    yAxisID: 'y',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                stacked: false,
                ...chartTooltipOptions,
                plugins: {
                    ...chartTooltipOptions.plugins,
                    title: {
                        display: true,
                        text: 'Precision vs. Recall by Probability Threshold',
                        color: brilliantBlues.textColor,
                        font: { size: 16 }
                    },
                    legend: {
                         labels: { color: brilliantBlues.textColor }
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        beginAtZero: true,
                        max: 1,
                        ticks: { color: brilliantBlues.textColor },
                        grid: { color: brilliantBlues.gridColor }
                    },
                    x: {
                         title: {
                            display: true,
                            text: 'Probability Threshold',
                            color: brilliantBlues.textColor
                         },
                         ticks: { color: brilliantBlues.textColor },
                         grid: { color: 'transparent' }
                    }
                }
            }
        });
    </script>

</body>
</html>
